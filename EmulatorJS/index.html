<!DOCTYPE html>
<html>
    <head>
        <title>Emuleitor de la población</title>
        <link rel="icon" href="docs/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body, html {
                height: 100%;
                background-color: black;
                color: white;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: monospace;
                font-weight: bold;
            }

            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .container h1 {
                margin: 0.5em 0;
            }

            .logo {
                width: 130px;
                height: 130px;
                filter: drop-shadow(0 0 10px white);
                margin-bottom: 1em;
            }

            #upload-area {
                width: 100vw;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px dashed #555;
                transition: border-color 0.2s;
                cursor: pointer;
            }

            #upload-area:hover {
                border-color: #38f;
            }

            #upload-area p {
                margin: 0;
                color: #aaa;
            }

            input[type="file"] {
                display: none;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>Emuleitor de la población</h1>
            <img src="docs/Logo-light.png" alt="Logo" class="logo">
            <div id="upload-area">
                <input type="file" id="input" accept=".nes,.smc,.fig,.sfc,.gd3,.gd7,.dx2,.bsx,.swc,.z64,.n64,.pce,.ngp,.ngc,.ws,.wsc,.col,.cv,.d64,.nds,.gba,.gb" />
                <p>Click aquí o arrastra un archivo ROM</p>
            </div>
        </div>

        <script>
            let enableDebug = false;
            let enableThreads = false;

            // Configuración de depuración y threads
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            if (urlParams.get('debug') == 1) enableDebug = true;
            if (urlParams.get('threads') == 1 && window.SharedArrayBuffer) enableThreads = true;

            const uploadArea = document.getElementById('upload-area');
            const input = document.getElementById('input');

            // Hacer que el área de carga sea clickeable y abra el selector de archivos
            uploadArea.addEventListener('click', () => input.click());

            // Función para manejar el cambio de archivo
            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;

                const url = file;
                const parts = file.name.split(".");
                const ext = parts.pop();

                // Selección del core según la extensión del archivo
                const core = await selectCore(ext);
                if (!core) return;

                // Preparar y cargar el emulador
                loadEmulator(core, url, parts.join('.'));
            };

            // Selección del core según el tipo de archivo
            async function selectCore(ext) {
                const coreMapping = {
                    "nes": ["fds", "nes", "unif", "unf"],
                    "snes": ["smc", "fig", "sfc", "gd3", "gd7", "dx2", "bsx", "swc"],
                    "n64": ["z64", "n64"],
                    "pce": ["pce"],
                    "ngp": ["ngp", "ngc"],
                    "ws": ["ws", "wsc"],
                    "coleco": ["col", "cv"],
                    "vice_x64sc": ["d64"]
                };

                for (const [core, extensions] of Object.entries(coreMapping)) {
                    if (extensions.includes(ext)) return core;
                }

                return null;
            }

            // Cargar el emulador con los parámetros seleccionados
            function loadEmulator(core, url, gameName) {
                const display = document.createElement("div");
                const game = document.createElement("div");
                const script = document.createElement("script");

                display.id = "display";
                game.id = "game";

                document.body.innerHTML = '';
                document.body.appendChild(display);
                display.appendChild(game);

                window.EJS_player = "#game";
                window.EJS_gameName = gameName;
                window.EJS_biosUrl = "";
                window.EJS_gameUrl = url;
                window.EJS_core = core;
                window.EJS_pathtodata = "data/";
                window.EJS_startOnLoaded = true;
                window.EJS_DEBUG_XX = enableDebug;
                window.EJS_disableDatabases = true;
                window.EJS_threads = enableThreads;

                script.src = "data/loader.js";
                document.body.appendChild(script);
            }
        </script>
    </body>
</html>
